<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Carte - Smart Delivery</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        #map { height: calc(100vh - 60px); width: 100%; }
        .map-controls {
            position: absolute;
            top: 80px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            width: 260px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
        }

        /* ===== LOGOUT BTN ===== */
        .logout-btn{
            padding:10px 18px;
            border-radius:8px;
            background:#e63946;
            color:white;
            border:none;
            cursor:pointer;
        }

        .logout-btn:hover{
            background:#c1121f;
        }
    </style>
</head>

<body>

<nav class="navbar">
 <div class="nav-container">
  <div class="logo"><i class="fas fa-box"></i><span>Smart Delivery</span></div>

  <ul class="nav-menu">
   <li><a href="/dashboard">Dashboard</a></li>
   <li><a href="/carte"  class="active" >Carte</a></li>
   <li><a href="/livreurs">Livreurs</a></li>
   <li><a href="/commandes">Commandes</a></li>
   <li>
      <button class="logout-btn" onclick="window.location='/logout'">
        <i class="fas fa-sign-out-alt"></i> D√©connexion
      </button>
    </li>
  </ul>

 </div>
</nav>

<div class="map-controls">
    <h3>üó∫Ô∏è Trajets</h3>

    <label>Livreur :</label>
    <select id="select-livreur" style="width:100%; margin-bottom:10px;">
        <option value="ALL">Tous</option>
    </select>

    <label><input type="checkbox" id="show-commandes" checked> Commandes</label><br>
    <label><input type="checkbox" id="show-depots" checked> D√©p√¥ts</label><br><br>

    <button onclick="centrerCarte()">üìç Centrer</button>
</div>

<div id="map"></div>

<script>
let map;
let polylines = {};
let markersDepots = [];
let markersCommandesParLivreur = {};

/* ===============================
   INIT MAP
   =============================== */
function initialiserCarte() {
    map = L.map('map').setView([31.63, -7.99], 12);

    const boundsMaroc = L.latLngBounds([20,-17.5],[36.5,-0.5]);
    map.setMaxBounds(boundsMaroc);
    map.setMinZoom(6);

    map.createPane('trajetsPane');
    map.createPane('depotsPane');
    map.createPane('commandesPane');

    map.getPane('trajetsPane').style.zIndex = 400;
    map.getPane('depotsPane').style.zIndex = 550;
    map.getPane('commandesPane').style.zIndex = 600;

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution:'¬© OpenStreetMap'
    }).addTo(map);

    chargerDonnees();
}

/* ===============================
   LOAD DATA
   =============================== */
async function chargerDonnees() {
    const trajets = (await (await fetch('/api/trajets')).json()).trajets || {};
    const livreurs = (await (await fetch('/api/livreurs')).json()).livreurs || [];

    afficherTrajets(trajets);
    afficherCommandesDepuisTrajets(trajets);
    afficherDepots(livreurs);
    remplirSelect(trajets);
}

/* ===============================
   TRAJETS
   =============================== */
function afficherTrajets(trajets) {
    const colors = ['#E91E63','#3F51B5','#009688','#FF9800','#9C27B0'];
    let i = 0;

    for (const [livreurId, t] of Object.entries(trajets)) {
        if (!t.route_geometry) continue;

        const latlngs = t.route_geometry.map(p => [p[1], p[0]]);

        const poly = L.polyline(latlngs,{
            color: colors[i++ % colors.length],
            weight: 5,
            opacity: 0.85,
            pane: 'trajetsPane'
        }).addTo(map);

        polylines[livreurId] = poly;
    }
}

/* ===============================
   üì¶ COMMANDES PAR LIVREUR
   =============================== */
function afficherCommandesDepuisTrajets(trajets) {

    const iconCommande = L.divIcon({
        html: `
            <div style="
                width:28px;
                height:28px;
                background:#FF9800;
                border-radius:50%;
                display:flex;
                align-items:center;
                justify-content:center;
                box-shadow:0 0 5px rgba(0,0,0,0.6);
            ">
                <i class="fas fa-box" style="color:white;font-size:14px;"></i>
            </div>
        `,
        className: '',
        iconSize: [28,28],
        iconAnchor: [14,14]
    });

    for (const [livreurId, t] of Object.entries(trajets)) {
        if (!t.points_gps) continue;

        markersCommandesParLivreur[livreurId] = [];

        t.points_gps.slice(1).forEach(pt => {
            const m = L.marker(
                [pt[0], pt[1]],
                {
                    icon: iconCommande,
                    pane: 'commandesPane',
                    zIndexOffset: 1000
                }
            ).addTo(map);

            markersCommandesParLivreur[livreurId].push(m);
        });
    }
}

/* ===============================
   üè¢ DEPOTS ‚Äî LOGO FIABLE
   =============================== */
function afficherDepots(livreurs) {

    const iconDepot = L.divIcon({
        html: `
            <div style="
                width:34px;
                height:34px;
                background:#2196F3;
                border-radius:50%;
                display:flex;
                align-items:center;
                justify-content:center;
                box-shadow:0 0 6px rgba(0,0,0,0.6);
            ">
                <i class="fas fa-warehouse" style="color:white;font-size:16px;"></i>
            </div>
        `,
        className: '',
        iconSize: [34,34],
        iconAnchor: [17,17]
    });

    livreurs.forEach(l => {
        const m = L.marker(
            [l.latitude_depart, l.longitude_depart],
            {
                icon: iconDepot,
                pane: 'depotsPane',
                zIndexOffset: 900
            }
        )
        .bindPopup(`<b>D√©p√¥t</b><br>${l.nom || l.id}`)
        .addTo(map);

        markersDepots.push(m);
    });
}

/* ===============================
   SELECT LIVREUR
   =============================== */
function remplirSelect(trajets) {
    const select = document.getElementById('select-livreur');

    Object.keys(trajets).forEach(id => {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = id;
        select.appendChild(opt);
    });

    select.onchange = () => {
        const val = select.value;

        for (const [id, p] of Object.entries(polylines)) {
            (val === 'ALL' || id === val) ? map.addLayer(p) : map.removeLayer(p);
        }

        for (const [id, markers] of Object.entries(markersCommandesParLivreur)) {
            markers.forEach(m =>
                (val === 'ALL' || id === val) ? map.addLayer(m) : map.removeLayer(m)
            );
        }
    };
}

/* ===============================
   CENTRER
   =============================== */
function centrerCarte() {
    const visibles = Object.values(polylines).filter(p => map.hasLayer(p));
    if (visibles.length) {
        map.fitBounds(L.featureGroup(visibles).getBounds());
    }
}

/* ===============================
   TOGGLES
   =============================== */
document.getElementById('show-commandes').onchange = e =>
    Object.values(markersCommandesParLivreur)
        .flat()
        .forEach(m => e.target.checked ? map.addLayer(m) : map.removeLayer(m));

document.getElementById('show-depots').onchange = e =>
    markersDepots.forEach(m => e.target.checked ? map.addLayer(m) : map.removeLayer(m));

initialiserCarte();
</script>

</body>
</html>