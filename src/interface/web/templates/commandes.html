<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Commandes</title>

<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
table{width:100%;border-collapse:collapse;background:white;border-radius:10px;overflow:hidden;}
th,td{padding:12px;text-align:center;border-bottom:1px solid #eee;}
th{background:#007bff;color:white;}
tr:hover{background:#f5f5f5;}
.btn-add{padding:10px 15px;background:#007bff;color:white;border-radius:6px;cursor:pointer;}
.action-btn{padding:6px 10px;border-radius:6px;color:white;cursor:pointer;}
.delete{background:#e63946;}

.form-overlay{
 position:fixed;inset:0;background:rgba(0,0,0,.55);
 display:none;align-items:center;justify-content:center;z-index:2000;
}
.form-popup{
 background:white;padding:20px;border-radius:10px;width:700px;
 max-height:90vh;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,.45);
}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
input{padding:8px;width:100%;}
.btn-save{background:#28a745;padding:10px;color:white;width:100%;border-radius:6px;margin-top:10px;cursor:pointer;}
.btn-close{background:#222;padding:8px;margin-top:8px;color:white;width:100%;border-radius:6px;cursor:pointer;}
.logout-btn{padding:10px 18px;border-radius:8px;background:#e63946;color:white;border:none;cursor:pointer;}

.result-box{
 width:500px;background:white;border-radius:12px;padding:25px;
 box-shadow:0 25px 60px rgba(0,0,0,.55);text-align:center;
}
.result-title{color:#007bff;font-size:22px;font-weight:bold;}
.result-content{
 margin-top:10px;background:#f4f7ff;padding:15px;border-radius:10px;
 border:1px solid #cfdcff;text-align:left;
}
</style>
</head>

<body>

<nav class="navbar">
 <div class="nav-container">
  <div class="logo"><i class="fas fa-box"></i><span>Smart Delivery</span></div>
  <ul class="nav-menu">
   <li><a href="/dashboard">Dashboard</a></li>
   <li><a href="/carte">Carte</a></li>
   <li><a href="/livreurs">Livreurs</a></li>
   <li><a href="/commandes" class="active">Commandes</a></li>
   <li><button class="logout-btn" onclick="window.location='/logout'">
    <i class="fas fa-sign-out-alt"></i> D√©connexion</button></li>
  </ul>
 </div>
</nav>

<section class="container">

<div class="page-header">
 <h2>üì¶ Gestion des Commandes</h2>
 <button class="btn-add" onclick="ouvrirAdd()">+ Ajouter Commande</button>
</div>

<table>
<thead>
<tr>
 <th>ID</th><th>Adresse</th><th>Poids</th><th>Priorit√©</th>
 <th>Client</th><th>Statut</th><th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<!-- ADD POPUP -->
<div class="form-overlay" id="popup-add">
 <div class="form-popup">
  <h3>Ajouter Commande</h3>

  <div class="form-grid">
   <input id="id" placeholder="ID (ex: CMD12345)" required>
   <input id="adresse" placeholder="Adresse" required>

   <input id="lat" type="number" step="0.000001" placeholder="Latitude" required>
   <input id="lng" type="number" step="0.000001" placeholder="Longitude" required>

   <div style="grid-column:1/3">
    <b>üìç Choisir sur la carte</b>
    <div id="map" style="height:300px;border-radius:10px"></div>
   </div>

   <input id="poids" type="number" min="1" max="50" placeholder="Poids (kg)" required>
   <input id="priorite" type="number" min="1" max="3" placeholder="Priorit√© (1-3)" required>

   <input id="client_id" placeholder="Client ID (optionnel)">
   <input id="client" placeholder="Nom client (si nouveau)">
   <input id="tel" placeholder="T√©l√©phone">
   <input id="email" type="email" placeholder="Email client">
  </div>

  <button class="btn-save" onclick="saveAdd()">Enregistrer</button>
  <button class="btn-close" onclick="fermerAdd()">Fermer</button>
 </div>
</div>

<!-- RESULT POPUP -->
<div class="form-overlay" id="result-popup">
 <div class="result-box">
  <div class="result-title">üéâ Client cr√©√©</div>
  <div id="result-content" class="result-content"></div>
  <button class="btn-close" onclick="fermerResult()">Fermer</button>
 </div>
</div>

</section>

<script>
const popupAdd = document.getElementById("popup-add");
const resultPopup = document.getElementById("result-popup");
const resultContent = document.getElementById("result-content");

/* MAP */
let map = L.map('map').setView([31.63,-8.01],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let marker=null;
map.on("click",e=>{
 lat.value=e.latlng.lat.toFixed(6);
 lng.value=e.latlng.lng.toFixed(6);
 if(marker) map.removeLayer(marker);
 marker=L.marker([lat.value,lng.value]).addTo(map);
});

/* POPUP */
function ouvrirAdd(){
 clearAddForm();
 popupAdd.style.display="flex";
 setTimeout(()=>map.invalidateSize(),300);
}
function fermerAdd(){ popupAdd.style.display="none"; }
function fermerResult(){ resultPopup.style.display="none"; }

/* VALIDATION */
function validateForm(){
 if(poids.value<1||poids.value>50){alert("Poids invalide");return false;}
 if(priorite.value<1||priorite.value>3){alert("Priorit√© invalide");return false;}
 return true;
}

/* SAVE */
async function saveAdd(){
 if(!validateForm()) return;

 const payload={
  id:id.value,adresse:adresse.value,
  latitude:lat.value,longitude:lng.value,
  poids:poids.value,priorite:priorite.value,
  client_id:client_id.value||null,
  client_nom:client.value,
  client_tel:tel.value,
  client_email:email.value,
  statut:"en_attente"
 };

 const res=await fetch("/api/commandes",{method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify(payload)});
 const r=await res.json();

 if(r.client_created){
  resultContent.innerHTML=`
   <p><b>Email :</b> ${r.client_email}</p>
   <p><b>Mot de passe :</b>
    <span style="font-size:20px;color:#007bff">${r.password}</span>
   </p>
   <p style="color:red">‚ö†Ô∏è Sauvegarde ce mot de passe</p>`;
  resultPopup.style.display="flex";
 }

 fermerAdd(); charger();
}

/* DELETE */
async function delCmd(id){
 if(!confirm("Supprimer ?")) return;
 await fetch(`/api/commandes/${id}`,{method:"DELETE"});
 charger();
}

/* LOAD */
async function charger(){
 const data=await (await fetch("/api/commandes")).json();
 tbody.innerHTML="";
 data.forEach(c=>{
  tbody.innerHTML+=`
   <tr>
    <td>${c.id}</td><td>${c.adresse}</td>
    <td>${c.poids} kg</td><td>${c.priorite}</td>
    <td>${c.client_nom??"-"}</td><td>${c.statut}</td>
    <td><button class="action-btn delete" onclick="delCmd('${c.id}')">Supprimer</button></td>
   </tr>`;
 });
}

/* CLEAR */
function clearAddForm(){
 id.value=adresse.value=lat.value=lng.value=poids.value=priorite.value="";
 client_id.value=client.value=tel.value=email.value="";
 if(marker){map.removeLayer(marker);marker=null;}
}

charger();
</script>

</body>
</html>
