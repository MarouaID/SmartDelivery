<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Commandes</title>

<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<style>

.page-header{
 display:flex;
 justify-content:space-between;
 align-items:center;
 margin-bottom:20px;
}

table{
 width:100%;
 border-collapse:collapse;
 background:white;
 border-radius:10px;
 overflow:hidden;
}

th,td{
 padding:12px;
 text-align:center;
 border-bottom:1px solid #eee;
}

th{
 background:#007bff;
 color:white;
}

tr:hover{
 background:#f5f5f5;
}

.btn-add{
 padding:10px 15px;
 background:#007bff;
 color:white;
 border-radius:6px;
 cursor:pointer;
}

.action-btn{
 padding:6px 10px;
 border-radius:6px;
 color:white;
 cursor:pointer;
}

.edit{ background:#ffa500; }
.delete{ background:#e63946; }

/* ================== POPUP OVERLAY ================== */

.form-overlay{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.55);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.form-popup{
    background:white;
    padding:20px;
    border-radius:10px;
    width:700px;
    max-height:90vh;
    overflow-y:auto;
    box-shadow:0 10px 40px rgba(0,0,0,0.45);
    animation: popup .25s ease;
}

@keyframes popup{
    from{ transform: scale(.9); opacity:0}
    to{ transform: scale(1); opacity:1}
}

.form-grid{
 display:grid;
 grid-template-columns:1fr 1fr;
 gap:10px;
}

input{
 padding:8px;
 width:100%;
}

.btn-save{
 background:#28a745;
 padding:10px;
 color:white;
 width:100%;
 border-radius:6px;
 margin-top:10px;
 cursor:pointer;
}

.btn-close{
 background:#222;
 padding:8px;
 margin-top:8px;
 color:white;
 width:100%;
 border-radius:6px;
 cursor:pointer;
}

/* ===== RESULT POPUP BEAUTIFUL STYLE ===== */
.result-box{
    width:520px;
    background:white;
    border-radius:12px;
    padding:25px;
    box-shadow:0 25px 60px rgba(0,0,0,.55);
    animation: popup .25s ease;
    text-align:center;
}

.result-title{
    color:#007bff;
    margin-bottom:10px;
    font-size:22px;
    font-weight:bold;
}

.result-content{
    margin-top:10px;
    font-size:16px;
    color:#222;
    background:#f4f7ff;
    padding:15px;
    border-radius:10px;
    border:1px solid #cfdcff;
    text-align:left;
}

.result-content p{ margin:6px 0; }

/* ===== LOGOUT BTN ===== */
    .logout-btn{
        padding:10px 18px;
        border-radius:8px;
        background:#e63946;
        color:white;
        border:none;
        cursor:pointer;
    }

    .logout-btn:hover{
        background:#c1121f;
    }

</style>
</head>

<body>

<nav class="navbar">
 <div class="nav-container">
  <div class="logo"><i class="fas fa-box"></i><span>Smart Delivery</span></div>

  <ul class="nav-menu">
   <li><a href="/dashboard">Dashboard</a></li>
   <li><a href="/carte">Carte</a></li>
   <li><a href="/livreurs">Livreurs</a></li>
   <li><a href="/commandes" class="active">Commandes</a></li>
   <li>
      <button class="logout-btn" onclick="window.location='/logout'">
        <i class="fas fa-sign-out-alt"></i> D√©connexion
      </button>
    </li>
  </ul>

 </div>
</nav>

<section class="container">

<div class="page-header">
 <h2>üì¶ Gestion des Commandes</h2>
 <button class="btn-add" onclick="ouvrirAdd()"> + Ajouter Commande</button>
</div>

<table>
<thead>
<tr>
 <th>ID</th>
 <th>Adresse</th>
 <th>Poids</th>
 <th>Volume</th>
 <th>Fen√™tre</th>
 <th>Priorit√©</th>
 <th>Client</th>
 <th>Statut</th>
 <th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>


<!-- ================= ADD POPUP ================= -->
<div class="form-overlay" id="popup-add">
  <div class="form-popup">

    <h3>Ajouter Commande</h3>

    <div class="form-grid">
        <input id="id" placeholder="ID">
        <input id="adresse" placeholder="Adresse">
        <input id="lat" placeholder="Latitude">
        <input id="lng" placeholder="Longitude">
        <input id="poids" placeholder="Poids">
        <input id="volume" placeholder="Volume">
        <input id="fd" placeholder="Fenetre d√©but">
        <input id="ff" placeholder="Fenetre fin">
        <input id="priorite" placeholder="Priorit√© (1-3)">
        <input id="service" placeholder="Temps service min">

        <input id="client_id" placeholder="Client ID (optionnel si existe)">
        <input id="client" placeholder="Nom Client (si nouveau)">
        <input id="tel" placeholder="T√©l√©phone Client">
        <input id="email" placeholder="Email Client">
    </div>

    <button class="btn-save" onclick="saveAdd()">Enregistrer</button>
    <button class="btn-close" onclick="fermerAdd()">Fermer</button>

  </div>
</div>


<!-- ================= EDIT POPUP ================= -->
<div class="form-overlay" id="popup-edit">
  <div class="form-popup">

    <h3>Modifier Commande</h3>

    <div class="form-grid">
        <input id="e_adresse">
        <input id="e_lat">
        <input id="e_lng">
        <input id="e_poids">
        <input id="e_volume">
        <input id="e_fd">
        <input id="e_ff">
        <input id="e_priorite">
        <input id="e_service">
        <input id="e_client">
        <input id="e_tel">
        <input id="e_statut">
    </div>

    <button class="btn-save" onclick="saveEdit()">Enregistrer</button>
    <button class="btn-close" onclick="fermerEdit()">Fermer</button>

  </div>
</div>


<!-- ================= RESULT POPUP ================= -->
<div class="form-overlay" id="result-popup">
  <div class="result-box">

      <h3 class="result-title">üéâ Commande Cr√©√©e</h3>

      <div id="result-content" class="result-content"></div>

      <button class="btn-close" onclick="fermerResult()">Fermer</button>

  </div>
</div>

</section>

<script>

let currentId = null;

function ouvrirAdd(){ clearAddForm(); document.getElementById("popup-add").style.display="flex"; }
function fermerAdd(){ document.getElementById("popup-add").style.display="none";}
function fermerEdit(){ document.getElementById("popup-edit").style.display="none"; }
function fermerResult(){ document.getElementById("result-popup").style.display="none"; }


async function charger(){
 const r = await fetch("/api/commandes");
 const data = await r.json();

 const body = document.getElementById("tbody");
 body.innerHTML="";

 data.forEach(c=>{
 body.innerHTML += `
 <tr>
  <td>${c.id}</td>
  <td>${c.adresse}</td>
  <td>${c.poids} kg</td>
  <td>${c.volume}</td>
  <td>${c.fenetre_debut} ‚Üí ${c.fenetre_fin}</td>
  <td>${c.priorite}</td>
  <td>${c.client_nom ?? "-"}</td>
  <td>${c.statut}</td>

  <td>
   <button class="action-btn edit" onclick="edit('${c.id}')">Modifier</button>
   <button class="action-btn delete" onclick="del('${c.id}')">Supprimer</button>
  </td>
 </tr>`;
 });
}


async function saveAdd(){

 const data = {
  id:id.value,
  adresse:adresse.value,
  latitude:lat.value,
  longitude:lng.value,
  poids:poids.value,
  volume:volume.value,
  fenetre_debut:fd.value,
  fenetre_fin:ff.value,
  priorite:priorite.value,
  temps_service:service.value,

  client_id:client_id.value || null,
  client_nom:client.value,
  client_tel:tel.value,
  client_email:email.value,

  statut:"en_attente"
 };

 const res = await fetch("/api/commandes",{
  method:"POST",
  headers:{ "Content-Type":"application/json"},
  body:JSON.stringify(data)
 });

 const result = await res.json();

 if(!result.success){
    alert("Erreur lors de l'ajout");
    return;
 }

 if(result.client_created){
    document.getElementById("result-content").innerHTML = `
        <p><b>ID Client :</b> ${result.client_id}</p>
        <p><b>Email :</b> <span style="color:#007bff">${result.client_email}</span></p>
        <p><b>Mot de Passe :</b>
          <span style="font-size:20px;color:#007bff;">${result.password}</span>
        </p>
        <p style="color:red;">
          ‚ö†Ô∏è Sauvegarde ce mot de passe car il ne sera plus affich√© !
        </p>
    `;
    document.getElementById("result-popup").style.display = "flex";
 }

 fermerAdd();
 clearAddForm();
 charger();
}


async function del(id){
 if(!confirm("Supprimer ?")) return;
 await fetch(`/api/commandes/${id}`,{method:"DELETE"});
 charger();
}


async function edit(id){
 currentId=id;

 const data = await (await fetch("/api/commandes")).json();
 const c = data.find(x=>x.id===id);

 e_adresse.value=c.adresse;
 e_lat.value=c.latitude;
 e_lng.value=c.longitude;
 e_poids.value=c.poids;
 e_volume.value=c.volume;
 e_fd.value=c.fenetre_debut;
 e_ff.value=c.fenetre_fin;
 e_priorite.value=c.priorite;
 e_service.value=c.temps_service;
 e_client.value=c.client_nom ?? "";
 e_tel.value=c.client_tel ?? "";
 e_statut.value=c.statut;

 document.getElementById("popup-edit").style.display="flex";
}


async function saveEdit(){

 const data = {
  adresse:e_adresse.value,
  latitude:e_lat.value,
  longitude:e_lng.value,
  poids:e_poids.value,
  volume:e_volume.value,
  fenetre_debut:e_fd.value,
  fenetre_fin:e_ff.value,
  priorite:e_priorite.value,
  temps_service:e_service.value,
  client_nom:e_client.value,
  client_tel:e_tel.value,
  statut:e_statut.value
 };

 await fetch(`/api/commandes/${currentId}`,{
  method:"PUT",
  headers:{ "Content-Type":"application/json"},
  body:JSON.stringify(data)
 });

 fermerEdit();
 charger();
}

function clearAddForm(){
    id.value = "";
    adresse.value = "";
    lat.value = "";
    lng.value = "";
    poids.value = "";
    volume.value = "";
    fd.value = "";
    ff.value = "";
    priorite.value = "";
    service.value = "";
    client_id.value = "";
    client.value = "";
    tel.value = "";
    email.value = "";
}

charger();
</script>

</body>
</html>