<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Smart Delivery</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>

    body{
        background:#f6f8ff;
    }

    /* ====== GLOBAL PAGE CONTAINER ====== */
    .page-wrapper{
        width:95%;
        max-width:1400px;
        margin:auto;
        margin-top:25px;
        margin-bottom:40px;
    }

    /* ====== HEADER ====== */
    .dashboard-header{
        margin-top:25px;
        margin-bottom:30px;
        background:white;
        padding:20px 30px;
        border-radius:12px;
        box-shadow:0 10px 30px rgba(0,0,0,.08);

        display:flex;
        justify-content:space-between;
        align-items:center;
    }

    .dashboard-header h1{
        margin:0;
    }

    /* ====== SECTION SPACING ====== */
    .stats-grid,
    .charts-grid,
    .table-card{
        margin-top:25px;
    }

    /* ===== LOGOUT BTN ===== */
    .logout-btn{
        padding:10px 18px;
        border-radius:8px;
        background:#e63946;
        color:white;
        border:none;
        cursor:pointer;
    }

    .logout-btn:hover{
        background:#c1121f;
    }

</style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar">
    <div class="nav-container">
        <div class="logo">
            <i class="fas fa-truck"></i>
            <span>Smart Delivery</span>
        </div>

        <ul class="nav-menu">
            <li><a href="/dashboard" class="active">Dashboard</a></li>
            <li><a href="/carte">Carte</a></li>
            <li><a href="/livreurs">Livreurs</a></li>
            <li><a href="/commandes">Commandes</a></li>

            <li>
                <button class="logout-btn" onclick="window.location='/logout'">
                    <i class="fas fa-sign-out-alt"></i> D√©connexion
                </button>
            </li>
        </ul>
    </div>
</nav>


<div class="page-wrapper">

    <!-- HEADER -->
    <div class="dashboard-header">
        <h1>üìä Dashboard</h1>

        <div style="display:flex; gap:12px;">
            <button class="btn btn-primary" onclick="rafraichirDonnees()">
                <i class="fas fa-sync"></i> Rafra√Æchir
            </button>

            <button type="button"
                    class="btn btn-secondary"
                    onclick="lancerOptimisationDashboard()"
                    id="btn-optim">
                <i class="fas fa-rocket"></i> Lancer Affectation / Trajets
            </button>
        </div>
    </div>


    <!-- ====== STATS ====== -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon blue">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-details">
                <h3 id="stat-livreurs">0</h3>
                <p>Livreurs Actifs</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon orange">
                <i class="fas fa-box"></i>
            </div>
            <div class="stat-details">
                <h3 id="stat-commandes">0</h3>
                <p>Commandes</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon green">
                <i class="fas fa-route"></i>
            </div>
            <div class="stat-details">
                <h3 id="stat-distance">0 km</h3>
                <p>Distance Totale</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon red">
                <i class="fas fa-euro-sign"></i>
            </div>
            <div class="stat-details">
                <h3 id="stat-cout">0 ‚Ç¨</h3>
                <p>Co√ªt Total</p>
            </div>
        </div>
    </div>


    <!-- ====== CHARTS ====== -->
    <div class="charts-grid">
        <div class="chart-card">
            <h3>üìà R√©partition des Commandes par Livreur</h3>
            <canvas id="chartCommandes"></canvas>
        </div>

        <div class="chart-card">
            <h3>‚è±Ô∏è Temps de Livraison par Trajet</h3>
            <canvas id="chartTemps"></canvas>
        </div>
    </div>


    <!-- ===== TABLE ===== -->
    <div class="table-card">
        <h3>üöö Liste des Trajets</h3>

        <div class="table-actions">
            <input type="text" placeholder="Rechercher..."
                   id="search-trajets"
                   class="search-input">

            <button class="btn btn-secondary" onclick="exporterCSV()">
                <i class="fas fa-file-csv"></i> Exporter CSV
            </button>
        </div>

        <table class="data-table" id="table-trajets">
            <thead>
            <tr>
                <th>Livreur</th>
                <th>Commandes</th>
                <th>Distance (km)</th>
                <th>Temps (min)</th>
                <th>Co√ªt (‚Ç¨)</th>
                <th>D√©part</th>
                <th>Retour</th>
                <th>Actions</th>
            </tr>
            </thead>

            <tbody id="tbody-trajets">
            </tbody>
        </table>
    </div>

</div>


<!-- ========== JS ========= -->
<script src="{{ url_for('static', filename='js/app.js') }}"></script>

<script>
let chartCommandes, chartTemps;

async function chargerDashboard() {
    try {
        const res = await fetch("/api/resultat");
        const data = await res.json();

        if (!data.success) {
            console.warn("Aucune optimisation encore");
            return;
        }

        // ===== STATS =====
        document.getElementById("stat-livreurs").textContent =
            Object.keys(data.affectations).length;

        document.getElementById("stat-commandes").textContent =
            Object.values(data.affectations)
                .reduce((sum, arr) => sum + arr.length, 0);

        let totalDistance = 0;
        let totalCout = 0;

        const routes = (data.trajets_optimises.routes || {});

        Object.values(routes).forEach(r => {
            totalDistance += r.distance_km || 0;
            totalCout += r.cost || 0;
        });


        document.getElementById("stat-distance").textContent =
            totalDistance.toFixed(2) + " km";

        document.getElementById("stat-cout").textContent =
            totalCout.toFixed(2) + " ‚Ç¨";

        // ===== TABLE =====
        afficherTrajets(routes);

        // ===== CHARTS =====
        creerGraphiques(routes);

    } catch (err) {
        console.error("Erreur dashboard:", err);
    }
}

function afficherTrajets(trajets) {
    const tbody = document.getElementById("tbody-trajets");
    tbody.innerHTML = "";

    for (const [livreurId, trajet] of Object.entries(trajets)) {
        tbody.innerHTML += `
        <tr>
            <td><strong>${livreurId}</strong></td>
            <td>${trajet.ordre_livraison.length}</td>
            <td>${trajet.distance_km.toFixed(2)}</td>
            <td>${trajet.duree_min}</td>
            <td>${trajet.cost.toFixed(2)}</td>
            <td>${trajet.heure_debut_tour}</td>
            <td>${trajet.heure_fin_tour}</td>
            <td>
                    <button class="btn-small" onclick="lancerSUMO('${livreurId}')">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        </tr>`;
    }
}

function creerGraphiques(trajets) {
    const livreurs = Object.keys(trajets);
    const nbCommandes = livreurs.map(id => trajets[id].ordre_livraison.length);
    const temps = livreurs.map(id => trajets[id].duree_min);

    // BAR
    const ctx1 = document.getElementById("chartCommandes");
    if (chartCommandes) chartCommandes.destroy();

    chartCommandes = new Chart(ctx1, {
        type: "bar",
        data: {
            labels: livreurs,
            datasets: [{
                label: "Commandes",
                data: nbCommandes,
                backgroundColor: "rgba(54,162,235,0.6)"
            }]
        }
    });

    // LINE
    const ctx2 = document.getElementById("chartTemps");
    if (chartTemps) chartTemps.destroy();

    chartTemps = new Chart(ctx2, {
        type: "line",
        data: {
            labels: livreurs,
            datasets: [{
                label: "Temps (minutes)",
                data: temps,
                borderColor: "red",
                fill: false
            }]
        }
    });
}

// ===== OPTIM BUTTON =====
async function lancerOptimisationDashboard() {
    const btn = document.getElementById("btn-optim");
    btn.disabled = true;
    btn.innerHTML = "‚è≥ Optimisation...";

    try {
        const res = await fetch("/api/optimiser", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({})
        });

        const data = await res.json();

        if (data.success) {
            alert("‚úÖ Optimisation r√©ussie !");
            chargerDashboard();
        } else {
            alert("‚ùå " + data.error);
        }

    } catch (e) {
        alert("‚ùå Erreur serveur");
    }

    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-rocket"></i> Lancer Affectation / Trajets';
}


// ===== SEARCH =====
document.addEventListener("DOMContentLoaded", () => {
    const s = document.getElementById("search-trajets");
    if (s) {
        s.addEventListener("input", e => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll("#tbody-trajets tr").forEach(r => {
                r.style.display = r.textContent.toLowerCase().includes(term) ? "" : "none";
            });
        });
    }
});


chargerDashboard();

</script>

<script>
async function lancerSUMO(livreurId) {
    try {
        await fetch(`/api/sumo/replay/${livreurId}`, {
            method: "POST"
        });

        alert(" Simulation SUMO lanc√©e pour " + livreurId);

    } catch (e) {
        alert("Impossible de lancer SUMO");
    }
}
</script>


</body>
</html>