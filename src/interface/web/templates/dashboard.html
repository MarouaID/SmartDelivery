<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Delivery - Dashboard</title>

    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <body>
    <!-- NAVBAR -->
    <nav class="navbar">
      <div class="nav-container">
        <div class="logo">
          <i class="fas fa-truck"></i>
          <span>Smart Delivery</span>
        </div>
        <ul class="nav-menu">
          <li><a href="/">Accueil</a></li>
          <li><a href="/dashboard" class="active">Dashboard</a></li>
          <li><a href="/carte">Carte</a></li>
          <li><a href="/livreurs">Livreurs</a></li>
          <li><a href="/commandes">Commandes</a></li>
          <li><a href="/suivi">Suivi Temps R√©el</a></li>
        </ul>
      </div>
    </nav>

    <!-- CONTENU -->
    <div class="dashboard">
      <!-- HEADER -->
      <div class="dashboard-header">
        <div>
          <h1>üìä Dashboard G√©n√©ral</h1>
          <p class="dashboard-subtitle">
            Vue globale des performances, trajets optimis√©s et activit√© du
            syst√®me.
          </p>
        </div>

        <button class="btn btn-primary" onclick="rafraichirDonnees()">
          <i class="fas fa-sync"></i> Rafra√Æchir
        </button>
      </div>

      <!-- STATISTIQUES -->
      <h2 class="section-title">üìå Statistiques Globales</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon blue"><i class="fas fa-users"></i></div>
          <div class="stat-details">
            <h3 id="stat-livreurs">0</h3>
            <p>Livreurs Actifs</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon orange"><i class="fas fa-box"></i></div>
          <div class="stat-details">
            <h3 id="stat-commandes">0</h3>
            <p>Commandes Actuelles</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon green"><i class="fas fa-route"></i></div>
          <div class="stat-details">
            <h3 id="stat-distance">0 km</h3>
            <p>Distance Totale</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon red"><i class="fas fa-euro-sign"></i></div>
          <div class="stat-details">
            <h3 id="stat-cout">0 ‚Ç¨</h3>
            <p>Co√ªt Total</p>
          </div>
        </div>
      </div>

      <!-- GRAPHIQUES -->
      <h2 class="section-title">üìà Visualisations</h2>

      <div class="charts-grid">
        <div class="chart-card">
          <h3>üì¶ Commandes par Livreur</h3>
          <canvas id="chartCommandes"></canvas>
        </div>

        <div class="chart-card">
          <h3>‚è±Ô∏è Temps de Livraison par Trajet</h3>
          <canvas id="chartTemps"></canvas>
        </div>
      </div>

      <!-- TABLE DES TRAJETS -->
      <h2 class="section-title">üöö D√©tails des Trajets Optimis√©s</h2>

      <div class="table-card">
        <div class="table-actions">
          <input
            type="text"
            placeholder="Rechercher..."
            id="search-trajets"
            class="search-input"
          />
          <button class="btn btn-secondary" onclick="exporterCSV()">
            <i class="fas fa-file-csv"></i> Exporter CSV
          </button>
        </div>

        <table class="data-table improved-table" id="table-trajets">
          <thead>
            <tr>
              <th><i class="fas fa-user"></i> Livreur</th>
              <th><i class="fas fa-box"></i> Commandes</th>
              <th><i class="fas fa-route"></i> Distance</th>
              <th><i class="fas fa-clock"></i> Temps</th>
              <th><i class="fas fa-euro-sign"></i> Co√ªt</th>
              <th><i class="fas fa-play"></i> D√©part</th>
              <th><i class="fas fa-flag-checkered"></i> Retour</th>
              <th><i class="fas fa-cog"></i> Actions</th>
            </tr>
          </thead>
          <tbody id="tbody-trajets">
            <!-- Rempli dynamiquement -->
          </tbody>
        </table>
      </div>
    </div>

    <!------------------------ JAVASCRIPT ------------------------>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>

    <script>
      let chartCommandes, chartTemps;

      async function chargerDashboard() {
        try {
          const statsRes = await fetch("/api/statistiques");
          const stats = await statsRes.json();

          document.getElementById("stat-livreurs").textContent =
            stats.livreurs_total || 0;
          document.getElementById("stat-commandes").textContent =
            stats.commandes_total || 0;
          document.getElementById("stat-distance").textContent =
            (stats.distance_totale_km || 0).toFixed(2) + " km";
          document.getElementById("stat-cout").textContent =
            (stats.cout_total_euro || 0).toFixed(2) + " ‚Ç¨";

          const trajetsRes = await fetch("/api/trajets");
          const trajetsData = await trajetsRes.json();
          const trajets = trajetsData.trajets || {};

          afficherTrajets(trajets);
          creerGraphiques(trajets);
        } catch (error) {
          console.error("Erreur:", error);
        }
      }

      function afficherTrajets(trajets) {
        const tbody = document.getElementById("tbody-trajets");
        tbody.innerHTML = "";

        for (const [livreurId, trajet] of Object.entries(trajets)) {
          const row = document.createElement("tr");

          row.innerHTML = `
            <td><strong>${livreurId}</strong></td>
            <td><span class="badge-trajet">${
              trajet.commandes.length
            }</span></td>
            <td>${trajet.metriques.distance_km.toFixed(2)} km</td>
            <td>${trajet.metriques.temps_minutes} min</td>
            <td>${trajet.metriques.cout_euro.toFixed(2)} ‚Ç¨</td>
            <td>${trajet.horaires.depart}</td>
            <td>${trajet.horaires.retour_estime}</td>
            <td>
                <button class="btn-view" onclick="voirDetails('${livreurId}')">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        `;

          tbody.appendChild(row);
        }
      }

      function creerGraphiques(trajets) {
        const livreurs = Object.keys(trajets);
        const nbCommandes = livreurs.map((l) => trajets[l].commandes.length);
        const temps = livreurs.map((l) => trajets[l].metriques.temps_minutes);

        // Graphique 1
        if (chartCommandes) chartCommandes.destroy();
        chartCommandes = new Chart(document.getElementById("chartCommandes"), {
          type: "bar",
          data: {
            labels: livreurs,
            datasets: [
              {
                label: "Commandes",
                data: nbCommandes,
                backgroundColor: "rgba(54, 162, 235, 0.6)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 1,
              },
            ],
          },
        });

        // Graphique 2
        if (chartTemps) chartTemps.destroy();
        chartTemps = new Chart(document.getElementById("chartTemps"), {
          type: "line",
          data: {
            labels: livreurs,
            datasets: [
              {
                label: "Temps (min)",
                data: temps,
                fill: true,
                backgroundColor: "rgba(255,99,132,0.2)",
                borderColor: "rgba(255,99,132,1)",
                borderWidth: 2,
              },
            ],
          },
        });
      }

      function voirDetails(livreurId) {
        window.location.href = `/livreurs?id=${livreurId}`;
      }

      function exporterCSV() {
        window.location.href = "/api/export/csv";
      }

      function rafraichirDonnees() {
        chargerDashboard();
      }

      // Init
      chargerDashboard();
    </script>
  </body>
</html>
